<!DOCTYPE html>
<html lang="en">





<head>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">

  <meta property="og:title" content="k8s lab 01" />
<meta property="og:description" content="Another day, another lab, this time something with k8s. I haven&rsquo;t done anything with it, just some hello-world examples and the ocassional ranting of &ldquo;we don&rsquo;t need this here&rdquo;." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://4cm3.dev/post/k8s-lab-01/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-10-27T09:00:11-05:00" /><meta property="og:site_name" content="Luis Uribe - blog" />

  <meta itemprop="name" content="k8s lab 01">
<meta itemprop="description" content="Another day, another lab, this time something with k8s. I haven&rsquo;t done anything with it, just some hello-world examples and the ocassional ranting of &ldquo;we don&rsquo;t need this here&rdquo;."><meta itemprop="datePublished" content="2021-10-20T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-10-27T09:00:11-05:00" />
<meta itemprop="wordCount" content="286">
<meta itemprop="keywords" content="" />
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="k8s lab 01"/>
<meta name="twitter:description" content="Another day, another lab, this time something with k8s. I haven&rsquo;t done anything with it, just some hello-world examples and the ocassional ranting of &ldquo;we don&rsquo;t need this here&rdquo;."/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    
    k8s lab 01
    
  </title>
  <link rel="stylesheet" href='https://4cm3.dev/css/site.min.css'>
  <link rel="canonical" href="https://4cm3.dev/post/k8s-lab-01/">
  <link rel="alternate" type="application/rss&#43;xml" href="https://4cm3.dev/index.xml" title="luisuribe">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer">
  <meta name="author" content="Luis Uribe">
  <meta name="description" content="Another day, another lab, this time something with k8s. I haven&rsquo;t done anything with it, just some hello-world examples and the ocassional ranting of &ldquo;we don&rsquo;t need this here&rdquo;.">
</head>
<body><nav class="navbar is-transparent " role="navigation" aria-label="main navigation">
  <div class="navbar-brand">
    <a class="navbar-item" href="https://4cm3.dev/">
      <figure class="image">
        <img alt="" class="is-rounded" src="https://www.gravatar.com/avatar/cd3838fa3b53b8d704cf08209f4a62e1?s=128&d=identicon">
      </figure>
    </a>
    <a class="navbar-item" href="https://4cm3.dev/">
      luisuribe
    </a>
  </div>

  <div class="navbar-menu">
    <div class="navbar-start">
      
    </div>

    <div class="navbar-end">
      <a class="navbar-item" href="/" rel="noopener" target="_blank">
        blog
      </a>
      <a class="navbar-item" href="/labs" rel="noopener" target="_blank">
        labs
      </a>
      <a class="navbar-item" href="/about" rel="noopener" target="_blank">
        about
      </a>

      
      <a class="navbar-item" href="https://github.com/luisuribe/" rel="noopener" target="_blank">
        <span class="icon">
          
            <img alt="icons/svg/github.svg" src='https://4cm3.dev/icons/svg/github.svg'>
          
        </span>
      </a>
      
      <a class="navbar-item" href="https://gitlab.com/luisuribe/" rel="noopener" target="_blank">
        <span class="icon">
          
            <img alt="icons/svg/gitlab.svg" src='https://4cm3.dev/icons/svg/gitlab.svg'>
          
        </span>
      </a>
      
      <a class="navbar-item" href="https://www.linkedin.com/in/luribe/" rel="noopener" target="_blank">
        <span class="icon">
          
            <img alt="icons/svg/linkedin.svg" src='https://4cm3.dev/icons/svg/linkedin.svg'>
          
        </span>
      </a>
      
      <a class="navbar-item" href="https://4cm3.dev/index.xml" target="_blank">
        <span class="icon">
          <img alt="rss" src='https://4cm3.dev/icons/svg/rss.svg'>
        </span>
      </a>
      
    </div>
  </div>
</nav>

  <section>
    <section class='hero is-small is-info is-fullwidth'>
      <div class="hero-body">
<div class="container">
  <h1 class="title">
    k8s lab 01
  </h1>
  <h2 class="subtitle">
    <time datetime='2021-10-20T00:00:00Z'>
      October 20, 2021
    </time>
    
  </h2>
</div>

      </div>
    </section>
    <section class="section">
      <div class="container">
<div class="content is-medium">
  <p>Another day, another lab, this time something with k8s. I haven&rsquo;t done anything with it, just some hello-world examples and the ocassional ranting of &ldquo;we don&rsquo;t need this here&rdquo;. First I started with a simple python service (forget the bad code, we&rsquo;ll fix it later)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span>():
</span></span><span style="display:flex;"><span>    docker_short_id <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>gethostname()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Hello, World! &#39;</span> <span style="color:#f92672">+</span> docker_short_id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>run(debug<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0.0.0.0&#39;</span>)
</span></span></code></pre></div><p>To expose the (flask) service with docker I had to add <code>app.run(host='0.0.0.0')</code></p>
<p>Dockerfile:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-docker" data-lang="docker"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> alpine:3.14</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apk add python3<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apk add py3-pip<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip3 install flask<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /opt/hello</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> FLASK_APP<span style="color:#f92672">=</span>hello
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ENV</span> FLASK_ENV<span style="color:#f92672">=</span>development
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;flask&#34;</span>, <span style="color:#e6db74">&#34;run&#34;</span>, <span style="color:#e6db74">&#34;--host=0.0.0.0&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 5000</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>And a Makefile</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Makefile" data-lang="Makefile"><span style="display:flex;"><span><span style="color:#a6e22e">build</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    docker build -t k8s-lab .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">run</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    docker run -it -p 5000:5000 k8s-lab
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">shell</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    docker run -it -p 5000:5000 k8s-lab /bin/sh
</span></span></code></pre></div><p>For initial tests, I&rsquo;m going with minikube</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
</span></span><span style="display:flex;"><span>sudo install minikube-linux-amd64 /usr/local/bin/minikube
</span></span><span style="display:flex;"><span>minikube kubectl -- get po -A
</span></span><span style="display:flex;"><span>alias kubectl<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;minikube kubectl --&#34;</span>
</span></span></code></pre></div><p>Then, read some docs and finish the <a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/">Learn Kubernetes Basic Tutorial</a></p>
<p>I also had to <a href="https://medium.com/swlh/how-to-run-locally-built-docker-images-in-kubernetes-b28fbc32cc1d">point the docker daemon to the minikube internal registry</a> (and build the image again)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt; minikube docker-env
</span></span><span style="display:flex;"><span>export DOCKER_TLS_VERIFY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>export DOCKER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;tcp://172.17.0.2:2376&#34;</span>
</span></span><span style="display:flex;"><span>export DOCKER_CERT_PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/home/user/.minikube/certs&#34;</span>
</span></span><span style="display:flex;"><span>export MINIKUBE_ACTIVE_DOCKERD<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;minikube&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># To point your shell to minikubeâ€™s docker-daemon, run:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># eval $(minikube -p minikube docker-env)</span>
</span></span></code></pre></div><p>Finally, the deployment file (<code>hello.yaml</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">k8s-lab-deployment</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">k8s-lab</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">k8s-lab</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">k8s-lab</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">k8s-lab</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">k8s-lab:1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><p>Create and tag a new build (because we&rsquo;re using minikube&rsquo;s registry), start the deployment and create a service</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make build
</span></span><span style="display:flex;"><span>docker tag k8s-lab k8s-lab:1
</span></span><span style="display:flex;"><span>kubectl apply -f hello.yaml
</span></span><span style="display:flex;"><span>kubectl expose deployment k8s-lab --type<span style="color:#f92672">=</span>LoadBalancer --port<span style="color:#f92672">=</span><span style="color:#ae81ff">5000</span>
</span></span></code></pre></div>
</div>


      </div>
    </section>
  </section><footer class="footer">


  <div class="content has-text-centered">
    <p>
      Last modified Jun 26, 2023 | template based on <a href="https://github.com/orf/bare-hugo-theme" target="_blank">Bare Hugo theme.</a>
    </p>

  </div>
</footer></body>
</html>
